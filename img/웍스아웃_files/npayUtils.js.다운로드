	/********************************************************
	 * 가맹점 연동 JavaScript UTils
	 ********************************************************/

	/********************************************************
	 * IE Edge Guide Layer
	 ********************************************************/
	function kcpShowEdgeGuide()
	{
		var guideUI_H = "423";
		var guideUI_W = "600";
		var guideUI_TOP = "";
		var guideUI_LEFT = "";
		var retEdgeGuide = false;
		
		var guideUI = "";
		guideUI += 	"<div id='edgeGuide' style='width:" + guideUI_W + "px;height:" + guideUI_H + "px;position:absolute; display:table; top:0; left:0; width:100%; height:100%;'>";
		guideUI += 	"<div style='display:table-cell; text-align:center; vertical-align:middle;'>";
		guideUI += 	"<div style='background:#fff;padding:30px;z-index:500;position:relative;width:540px;height:423px;'>";
		guideUI += 	"<h1 style='font-size:25px;line-height:27px;font-weight:700;color:#000;padding:0px 0 20px;text-align:center'>IE Edge 환경 결제 안내</h1>";
		guideUI += 	"<p>Win10 Edge 환경에서는 결제가 원활하지 않을 수 있습니다.</p>";            
		guideUI += 	"<div style='background:#f3f3f4;padding:18px 0;width:100%;font-size:15px;color:#1a1a1a;text-align:center;margin-top:15px;'>";
		guideUI += 	"<span style='background:url(https://npay.kcp.co.kr/img/pop_sp.png) no-repeat;display:inline-block;width:15px;height:15px;vertical-align:middle;margin:-2px 0px 0 10px;'></span>";
		guideUI += 	" 호환성 설정 해제 후 결제를 진행 하실 수 있습니다.";
		guideUI += 	"</div>";
		guideUI += 	"<p style='padding:20px 0'>";
		guideUI += 	"호환성 설정은 <a href='javascript:Edge_guide_Pop();' title='새창' style='text-decoration:underline;font-weight:500;' >이 곳</a>을 클릭하신 후,<br>"; 
		guideUI += 	"개발자설정 > Microsoft 호환성 목록 사용 항목을 '체크해제'로<br>";
		guideUI += 	"설정하시면 됩니다. 설정 후 이 창으로 돌아와<br>";
		guideUI += 	"설정완료 버튼을 클릭하시면 결제를 진행할 수 있습니다.";
		guideUI += 	"</p>";
		guideUI += 	"<p style='color:#207bba'>※ 설정후에도 진행이 안 될 경우 창을 새로 여시기 바랍니다.</p>";
		guideUI +=	"<form id='kcpEdgeGuideForm' name='kcpEdgeGuideForm'>";
		guideUI +=	"<input type='hidden' id='res_cd' name='res_cd' value='3001'>";
		guideUI +=	"<input type='hidden' id='res_msg' name='res_msg' value='사용자 취소'>";
		guideUI +=	"<input type='hidden' id='ret_url' name='ret_url' value=''>";
		guideUI +=	"</form>";		
		guideUI += 	"<div style='height:45px;text-align:center;margin-top:20px;position:absolute;left:0;right:0;bottom:30px;overflow:hidden;z-index:200;'>";
		guideUI += 	"<button type='button' onclick='npayUtilCancelProc(document.kcpEdgeGuideForm);' style=':hidden;display:inline-block;color:#fff;font-size:15px;font-weight:700;text-align:center;border:none;background:#8f8f8f;width:158px;height:45px;line-height:45px;border-radius:3px;margin-right:5px;'>취소</button>";
		guideUI += 	"<button type='button' style='overflow:hidden;display:inline-block;color:#fff;font-size:15px;font-weight:700;text-align:center;border:none;background:#3b3b3b;width:158px;height:45px;line-height:45px;border-radius:3px;' onclick='settingEdgeGuide();'>설정완료</button>";
		guideUI += 	"</div>";
		guideUI += 	"<a href='javascript:npayUtilCancelProc(document.kcpEdgeGuideForm);' style='position:absolute;top:17px;right:17px;cursor:pointer;width:18px;height:18px;'>";
		guideUI += 	"<img src='https://npay.kcp.co.kr/img/btn_pop_close.png' alt='닫기' />";
		guideUI += 	"</a>";
		guideUI += 	"</div>";
		guideUI += 	"</div>";
		guideUI += 	"</div>";
		
		guideUI_TOP = getTopNaxPay(guideUI_H);
		guideUI_LEFT = getLeftNaxPay(guideUI_W);
		
		KCP_JQUERY.blockUI({
			message:guideUI
			,css:{
				top:guideUI_TOP
				,left:guideUI_LEFT
			}
		});
		
		KCP_JQUERY("#NAX_BLOCK").css("width","600px");
	}
	

	function kcpShowEdgeEngGuide()
	{
		var guideUI_H = "423";
		var guideUI_W = "600";
		var guideUI_TOP = "";
		var guideUI_LEFT = "";
		var retEdgeGuide = false;
		
		var guideUI = "";

		guideUI += 	"<div id='edgeGuide' style='width:" + guideUI_W + "px;height:" + guideUI_H + "px;position:absolute; display:table; top:0; left:0; width:100%; height:100%;'>";
		guideUI += 	"<div style='display:table-cell; text-align:center; vertical-align:middle;'>";
		guideUI += 	"<div style='background:#fff;padding:30px;z-index:500;position:relative;width:540px;height:423px;'>";
		guideUI += 	"<h1 style='font-size:25px;line-height:27px;font-weight:700;color:#000;padding:0px 0 20px;text-align:center'>User Instruction for Edge browser payment</h1>";
		guideUI += 	"<p>Payment may not work in Edge browser.</p>";            
		guideUI += 	"<div style='background:#f3f3f4;padding:18px 0;width:100%;font-size:15px;color:#1a1a1a;text-align:center;margin-top:15px;'>";
		guideUI += 	"<span style='background:url(https://npay.kcp.co.kr/img/pop_sp.png) no-repeat;display:inline-block;width:15px;height:15px;vertical-align:middle;margin:-2px 0px 0 10px;'></span>";
		guideUI += 	" Payment is possible after compatibility view is disabled.";
		guideUI += 	"</div>";
		guideUI += 	"<p style='padding:20px 0'>";
	    guideUI += 	"To disable compatibility view, click <a href='javascript:Edge_guide_Pop();' title='new window' >HERE</a> to go to<br>";
	    guideUI += 	"developer settings and uncheck “Use Microsoft compatibility lists”.<br>";
	    guideUI += 	"After setting is done, you are able to proceed payment<br>";
	    guideUI += 	"by clicking “Setting complete”.";
		guideUI += 	"</p>";
		guideUI += 	"<p style='color:#207bba' >※ Open a new window if you cannot proceed even after the setting.</p>";
		guideUI +=	"<form id='kcpEdgeGuideForm' name='kcpEdgeGuideForm'>";
		guideUI +=	"<input type='hidden' id='res_cd' name='res_cd' value='3001'>";
		guideUI +=	"<input type='hidden' id='res_msg' name='res_msg' value='사용자 취소'>";
		guideUI +=	"<input type='hidden' id='ret_url' name='ret_url' value=''>";
		guideUI +=	"</form>";		
		guideUI += 	"<div style='height:45px;text-align:center;margin-top:20px;position:absolute;left:0;right:0;bottom:30px;overflow:hidden;z-index:200;' >";
		guideUI += 	"<button type='button' onclick='npayUtilCancelProc(document.kcpEdgeGuideForm);' style=':hidden;display:inline-block;color:#fff;font-size:15px;font-weight:700;text-align:center;border:none;background:#8f8f8f;width:158px;height:45px;line-height:45px;border-radius:3px;margin-right:5px;'>Cancel</button>";
		guideUI += 	"<button type='button' style='overflow:hidden;display:inline-block;color:#fff;font-size:15px;font-weight:700;text-align:center;border:none;background:#3b3b3b;width:158px;height:45px;line-height:45px;border-radius:3px;' onclick='settingEdgeGuide();'>Setting Complete</button>";
		guideUI += 	"</div>";
		guideUI += 	"<a href='javascript:npayUtilCancelProc(document.kcpEdgeGuideForm);' style='position:absolute;top:17px;right:17px;cursor:pointer;width:18px;height:18px;'>";
		guideUI += 	"<img src='https://npay.kcp.co.kr/img/btn_pop_close.png' alt='닫기' />";
		guideUI += 	"</a>";
		guideUI += 	"</div>";
		guideUI += 	"</div>";
		guideUI += 	"</div>";		
		
		guideUI_TOP = getTopNaxPay(guideUI_H);
		guideUI_LEFT = getLeftNaxPay(guideUI_W);
		
		KCP_JQUERY.blockUI({
			message:guideUI
			,css:{
				top:guideUI_TOP
				,left:guideUI_LEFT
			}
		});
		
		KCP_JQUERY("#NAX_BLOCK").css("width","600px");
	}	
	
    /********************************************
	 * IE Edge 일 경우, about:flags 팝업창 활성화
	 ********************************************/
	var kcpEdgeCheck_popup_obj;
	
	
    /********************************************
	 * IE Edge 팝업 차단 체크
	 ********************************************/	
    function Edge_guide_Pop() 
    { 
        var edgeCheck_popup_obj = window.open( "about:flags", "edge_guide_pop", "top=0,left=0,height=500, width=500" );
        
        if( edgeCheck_popup_obj == null || typeof edgeCheck_popup_obj == "undefined" ) 
        { 
            alert( "팝업차단 설정을 확인 해주세요." ); 
        } 
    } 
		
	
	/******************************************
	 * [ IE-Edge Guide 설정 완료 버튼 클릭 ]
	 *****************************************/
	function settingEdgeGuide()
	{
		// about:flags 창 제거
		if(kcpEdgeCheck_popup_obj != null && typeof kcpEdgeCheck_popup_obj != "undefined" && !kcpEdgeCheck_popup_obj.closed )
		{
			kcpEdgeCheck_popup_obj.close();
		}
		
		try
		{
			// 가이드 레이어 제거
			removeEdgeGuide();
			
			//ie EDGE 일때 NAX_BLOCK 2개 생기는 원인때문에 이미 생성되어 있을시 remove // indus 사이트에서 2.0 뜨지 않았음 TEST 필요 -> 테스트 완료
			if(typeof KCP_JQUERY("#NAX_BLOCK") != "undefined")
			{
				KCP_JQUERY("#NAX_BLOCK").remove();
			}
			
			
			// 결제창 호출 버전 분기 처리
			var EDGE_KCP_WEB_PAYMENT_FLAG = KCP_GetWebPaymentVer( PARENT_FORM );
			
			if( EDGE_KCP_WEB_PAYMENT_FLAG == "SPAY" )
			{
				// SPay 결제창 호출
				if( KCP_NAX_POPUP_FLAG )
				{
					Extract_SPayPopup(PARENT_FORM, KCP_PARENT_ENCTYPE);		// Popup 결제창 호출 (SPAY)
				}
				else
				{
					Extrace_SPayService(PARENT_FORM, KCP_PARENT_ENCTYPE);	// IFrame 결제창 호출
				}
			}
			else
			{
				// NPay 결제창 호출
				if( KCP_NAX_POPUP_FLAG )
				{
					// Popup 결제창 호출
					ExtractNPayPopup(PARENT_FORM, KCP_PARENT_ENCTYPE);
				}
				else
				{
					// IFrame 결제창 호출
					ExtraceNPayService(PARENT_FORM, KCP_PARENT_ENCTYPE);	
				}
				
			}
			
		}
		catch(e)
		{
			// NPay 결제창 호출
			if( KCP_NAX_POPUP_FLAG )
			{
				// Popup 결제창 호출
				ExtractNPayPopup(PARENT_FORM, KCP_PARENT_ENCTYPE);
			}
			else
			{
				// IFrame 결제창 호출
				ExtraceNPayService(PARENT_FORM, KCP_PARENT_ENCTYPE);	
			}
			
		}
			
		
	}	
	

	/******************************************
	 * [ IE-Edge 호환성 보기 설정 취소 ]
	 * 
	 * - 가이드 레이어 제거
	 *****************************************/
	function removeEdgeGuide()
	{
		// about:flags 창 제거
		if(kcpEdgeCheck_popup_obj != null && typeof kcpEdgeCheck_popup_obj != "undefined" && !kcpEdgeCheck_popup_obj.closed )
		{
			kcpEdgeCheck_popup_obj.close();
		}
		
		KCP_JQUERY("#edgeGuide").remove();
		KCP_JQUERY.unblockUI();
	}
	
	
	/*******************************************************
	 * [ 사용자 취소/결제창 오류 확인 버튼 처리 ]
	 * @param formObj
	 *******************************************************/
	function npayUtilCancelProc(formObj)
	{
		var res_cd 			= "";
		var res_msg 		= "";
		var returnURL		= "";
		var clientDN		= "";

		try
		{
			removeEdgeGuide();
			
			if( typeof formObj.ret_url != "undefined" && formObj.ret_url.value != ""  && formObj.ret_url.value != "null" )
			{
				returnURL			= formObj.ret_url.value;
				clientDN			= getNpayUtilClientDomain(returnURL);
			}

			if(typeof formObj == "undefined" || formObj == null)
			{
				res_cd 	= "3001";
				res_msg = "사용자 취소";
			}
			else
			{
				if( typeof formObj.res_cd != "undefined" && formObj.res_cd.value != "" && formObj.res_cd.value != null )
				{
					res_cd 	= formObj.res_cd.value;
					res_msg = formObj.res_msg.value;
				}
				else
				{
					res_cd 		= "3001";
					res_msg 	= "사용자 취소";
				}
			}
		}
		catch(e)
		{
			res_cd 		= "3001";
			res_msg 	= "사용자 취소";
		}

		setTimeout(function(){
			try
			{
				if( chkAvailableNpayUtilPostMessage() )
				{
					// PostMessage 방식으로만 리턴
					sendNpayUtilPostMessage(res_cd, res_msg, clientDN, formObj, "cancel");
				}
				else
				{
					// RETURN URL 방식으로 리턴
					sendNpayUtilSubmitData(res_cd, res_msg, returnURL, formObj);
				}
			}
			catch(e)
			{
				if( chkAvailableNpayUtilPostMessage() )
				{
					// PostMessage 방식으로만 리턴
					sendNpayUtilPostMessage(res_cd, res_msg, clientDN, formObj, "cancel");
				}
				else
				{
					// RETURN URL 방식으로 리턴
					sendNpayUtilSubmitData(res_cd, res_msg, returnURL, formObj);
				}
			}
		}, 500);
	}
	
	
	/*******************************************************
	 * 리턴 URL 에서 도메인 정보만 추출
	 *
	 * @param returnURL
	 * @returns 도메인명
	 *******************************************************/
	function getNpayUtilClientDomain(returnURL)
	{
		var retDN 		= "";
		var httpLen 	= 0;
		var httpInfo 	= "";

		try
		{
			if(returnURL != null && returnURL != "" && returnURL.length > 0)
			{
				if(returnURL.indexOf("http://") > -1 )
				{
					httpInfo 	= "http://";
					httpLen 	= httpInfo.length;
				}
				else if (returnURL.indexOf("https://") > -1 )
				{
					httpInfo 	= "https://";
					httpLen 	= httpInfo.length;
				}
				else
				{
					httpLen = 0;
				}
			}

			if(httpLen > 0)
			{
				retDN = returnURL.substring(httpLen, returnURL.length);
				return httpInfo + retDN.substring(0, retDN.indexOf("/"));
			}
			else
			{
				return "";
			}
		}
		catch(e)
		{
			return "";
		}
	}
	
	/*******************************************************
	 * Form submit
	 *******************************************************/
	function sendNpayUtilSubmitData(res_cd, res_msg, returnURL, formObj)
	{
		formObj.target = "_self";
		formObj.action = returnURL;
		formObj.submit();
	}
	
	
	/*******************************************************
	 * [ PostMessage 로 Handler 페이지 데이터 전달 ]
	 * - data 인코딩 - encodeURIComponent
	 * - IE 브라우저의 경우, 팝업에서는 postMessage 사용할수 없음(IFrame 가능)
	 *   따라서, 팝업일 경우 opener의 메소드 호출
	 *******************************************************/
	function sendNpayUtilPostMessage(res_cd, res_msg, clientDN, formObj, retAction)
	{
		var kcp_npay_invoke_type 	= "";
		var jsonRetData 			= getNpayUtilJSonDataToFrom(formObj);
		var res_cd					= "";
		var res_msg					= "";
		
		if( formObj != null && typeof formObj != "undefined" && formObj != "" )
		{
			if( typeof formObj.res_cd != "undefined" )
			{
				res_cd = formObj.res_cd.value;
				res_msg = formObj.res_msg.value;
			}
		}

		if( window.opener == null )	kcp_npay_invoke_type = "parent";	// iframe 결제창
		else						kcp_npay_invoke_type = "opener";	// 팝업 결제창

		jsonRetData = getNpayUtilJSonDataRes(res_cd, res_msg);	

		if( kcp_npay_invoke_type == "opener" )
		{
			sendNpayUtilPostPopExecute(clientDN, jsonRetData, retAction)
		}
		else if( kcp_npay_invoke_type == "parent" )
		{
			sendNpayUtilPostIfrExecute(clientDN, jsonRetData, retAction);
		}

	}
	
	
	/*******************************************************
	 * postMessage 지원여부 체크
	 *
	 * return : true = 지원 / false = 미지원
	 *******************************************************/
	function chkAvailableNpayUtilPostMessage()
	{
		if(typeof window.postMessage == "undefined")
		{
			return false;	// post message 미지원
		}
		else
		{
			return true;	// post.message 지원
		}
	}	
	
	
	function sendNpayUtilPostPopExecute(clientDN, jsonRetData, retAction)
	{
		// postMessage를 nonaxPopupIntro(IFrame)로 보내기 위해 현재 도메인 추출
		if(clientDN != "" && clientDN != null && clientDN != "undefined")
		{
			window.opener.kcpReceiveMsg(jsonRetData, "");		// IE 팝업에서 postMessage 사용 불가
		}
		else
		{
			window.opener.kcpReceiveMsg(jsonRetData, clientDN);	// IE 팝업에서 postMessage 사용 불가
		}
	}


	function sendNpayUtilPostIfrExecute(clientDN, jsonRetData, retAction)
	{
		if(clientDN != "" && clientDN != null && clientDN != "undefined")
		{
			window.parent.postMessage(jsonRetData, clientDN);
		}
		else
		{
			window.parent.postMessage(jsonRetData, "*");
		}
	}	
	
	
	function getNpayUtilJSonDataRes(res_cd, res_msg)
	{
		var jsonData 	= "{" + "\"res_cd\":\""  + res_cd + "\"," + "\"res_msg\":\""  + res_msg + "\"" + "}";
		return jsonData;
	}	
	
	
	/*******************************************************
	 * [ form 데이터 기반 value 값을 encodeURI 한 동적 form 생성 ]
	 *
	 * return json Object
	 *******************************************************/
	function getNpayUtilJSonDataToFrom(formObj)
	{
		var jsonData 	= "{";
		var cnt 		= 0;

	    try
	    {
	    	$.each( $( formObj ).serializeArray(), function( i, field ) {
	    	    if( field.value != "" )
	    	    {
	    	        if( cnt++ > 0 )
	    	        {
	    	            jsonData += ",";
	    	        }

	    	        jsonData += "\"" + field.name + "\":\"" + encodeURI(field.value) + "\"";
	    	    }
	    	});

	    	jsonData += "}";

	    	return jsonData;
	    }
	    catch(e)
	    {
	        return "";
	    }
	}	

